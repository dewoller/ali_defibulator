---
title: "AED Coverage Analysis - Interactive Map"
output: 
  html_document:
    self_contained: true
    theme: flatly
    toc: true
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)

library(leaflet)
library(sf)
library(dplyr)
library(htmlwidgets)
library(DT)
library(targets)

# Load the data from targets
tar_load(c(
  'sua_noh_sf',
  'sua_noh_mesh_export',
  'victoria_defib_cleaned_sf', 
  'vacar_sf',
  'vacar_export',
  'reservoir_buffered_sf'
))

# Join vacar_sf with vacar_export to get both coordinates and analysis data
vacar_map_data <- vacar_sf %>%
  inner_join(
    vacar_export %>% select(va_internal_id, distance2defib, duration2defib, closest_defib_name, within_how_many_sua),
    by = "va_internal_id"
  )
```

# AED Coverage Analysis Dashboard

This interactive map visualizes the relationship between Automated External Defibrillator (AED) locations, their service catchment areas, and cardiac arrest incidents in Melbourne.

## Key Findings

```{r summary-stats}
# Calculate summary statistics
total_aeds <- nrow(victoria_defib_cleaned_sf)
sja_aeds <- sum(victoria_defib_cleaned_sf$is_sja_defib, na.rm = TRUE)
total_arrests <- nrow(vacar_export)
arrests_in_suas <- sum(vacar_export$within_how_many_sua > 0, na.rm = TRUE)
suas_with_arrests <- sum(sua_noh_mesh_export$n_vacar_arrest > 0, na.rm = TRUE)

cat("üìç **Total AEDs:** ", total_aeds, " (", sja_aeds, " SJA, ", total_aeds - sja_aeds, " Non-SJA)\n\n")
cat("üöë **Total Cardiac Arrests:** ", total_arrests, "\n\n")
cat("üéØ **Coverage:** ", arrests_in_suas, " arrests (", round(arrests_in_suas/total_arrests*100, 1), "%) fall within AED catchments\n\n")
cat("üìä **Active SUAs:** ", suas_with_arrests, " out of ", nrow(sua_noh_sf), " catchment areas contain cardiac arrests\n\n")
```

## Interactive Map

```{r interactive-map, fig.height=8}
# Join SUA geometries with arrest count data
sua_data <- sua_noh_sf %>%
  left_join(
    sua_noh_mesh_export %>% 
      select(sua_id, n_vacar_arrest, cald_pop, age_55_plus_pop) %>%
      mutate(
        cald_pop = as.numeric(cald_pop),
        age_55_plus_pop = as.numeric(age_55_plus_pop)
      ),
    by = "sua_id"
  ) %>%
  mutate(
    arrest_count = coalesce(n_vacar_arrest, 0),
    arrest_category = case_when(
      arrest_count == 0 ~ "No arrests",
      arrest_count == 1 ~ "1 arrest", 
      arrest_count >= 2 ~ "2+ arrests"
    )
  )

# Color palette for SUAs
sua_colors <- colorFactor(
  palette = c("#cccccc", "#ffaa66", "#ff4444"),
  domain = c("No arrests", "1 arrest", "2+ arrests")
)

# Create the map
map <- leaflet() %>%
  addProviderTiles(providers$OpenStreetMap.Mapnik) %>%
  setView(lng = 145.02, lat = -37.72, zoom = 13) %>%
  
  # Add reservoir boundary
  addPolygons(
    data = reservoir_buffered_sf,
    fillColor = "#ffaa00",
    color = "#ff6600", 
    weight = 2,
    opacity = 0.8,
    fillOpacity = 0.1,
    popup = "<strong>Reservoir Study Area</strong><br>400m buffer around Reservoir suburb",
    group = "Study Area"
  ) %>%
  
  # Add SUA catchments
  addPolygons(
    data = sua_data,
    fillColor = ~sua_colors(arrest_category),
    color = "#666666",
    weight = 1,
    opacity = 0.8,
    fillOpacity = 0.4,
    popup = ~paste0(
      "<strong>SUA ID:</strong> ", sua_id, "<br>",
      "<strong>Company:</strong> ", company, "<br>",
      "<strong>Address:</strong> ", address, "<br>",
      "<strong>SJA AED:</strong> ", ifelse(is_sja_defib, "Yes", "No"), "<br>",
      "<strong>Cardiac Arrests:</strong> ", coalesce(n_vacar_arrest, 0), "<br>",
      "<strong>Area:</strong> ", round(sua_area), " m¬≤<br>",
      "<strong>CALD Population:</strong> ", round(coalesce(cald_pop, 0)), "<br>",
      "<strong>Age 55+ Population:</strong> ", round(coalesce(age_55_plus_pop, 0))
    ),
    group = "SUA Catchments"
  ) %>%
  
  # Add AED locations
  addCircleMarkers(
    data = victoria_defib_cleaned_sf, 
    radius = 6,
    fillColor = ~ifelse(is_sja_defib, "#44ff44", "#4444ff"),
    color = "#000000",
    weight = 1,
    opacity = 1,
    fillOpacity = 0.8,
    popup = ~paste0(
      "<strong>AED Location</strong><br>",
      "<strong>Company:</strong> ", company, "<br>",
      "<strong>Address:</strong> ", address, "<br>",
      "<strong>Postcode:</strong> ", postcode, "<br>",
      "<strong>SJA AED:</strong> ", ifelse(is_sja_defib, "Yes", "No"), "<br>",
      "<strong>Arrests in catchment:</strong> ", coalesce(n_vacar_arrest, 0)
    ),
    group = "AED Locations"
  ) %>%
  
  # Add cardiac arrests
  addCircleMarkers(
    data = vacar_map_data,
    radius = 4,
    fillColor = "#ff4444",
    color = "#000000", 
    weight = 1,
    opacity = 1,
    fillOpacity = 0.6,
    popup = ~paste0(
      "<strong>Cardiac Arrest</strong><br>",
      "<strong>Date:</strong> ", va_date, "<br>",
      "<strong>Age:</strong> ", va_ageyears, " years<br>",
      "<strong>Gender:</strong> ", ifelse(va_malegender, "Male", "Female"), "<br>",
      "<strong>Distance to AED:</strong> ", round(coalesce(distance2defib, 0)), "m<br>",
      "<strong>Duration to AED:</strong> ", round(coalesce(duration2defib, 0), 1), " min<br>",
      "<strong>Closest AED:</strong> ", closest_defib_name, "<br>",
      "<strong>Within SUA:</strong> ", ifelse(coalesce(within_how_many_sua, 0) > 0, "Yes", "No")
    ),
    group = "Cardiac Arrests"
  ) %>%
  
  # Add layer controls
  addLayersControl(
    overlayGroups = c("Study Area", "SUA Catchments", "AED Locations", "Cardiac Arrests"),
    options = layersControlOptions(collapsed = FALSE)
  ) %>%
  
  # Add legend
  addLegend(
    position = "bottomright",
    colors = c("#ff4444", "#4444ff", "#44ff44", "#cccccc", "#ffaa66", "#ff4444"),
    labels = c(
      "Cardiac Arrests",
      "Non-SJA AEDs", 
      "SJA AEDs",
      "SUAs: No arrests",
      "SUAs: 1 arrest", 
      "SUAs: 2+ arrests"
    ),
    opacity = 0.8,
    title = "Legend"
  )

map
```

## Data Tables

### SUA Summary Statistics

```{r sua-table}
sua_summary <- sua_noh_mesh_export %>%
  select(
    SUA_ID = sua_id,
    Company = company,
    Address = address,
    `SJA AED` = is_sja_defib,
    `Cardiac Arrests` = n_vacar_arrest,
    `Area (m¬≤)` = sua_area,
    `CALD Pop` = cald_pop,
    `Age 55+ Pop` = age_55_plus_pop
  ) %>%
  mutate(
    `SJA AED` = ifelse(`SJA AED`, "Yes", "No"),
    `Cardiac Arrests` = coalesce(`Cardiac Arrests`, 0),
    across(c(`Area (m¬≤)`, `CALD Pop`, `Age 55+ Pop`), ~round(as.numeric(.x), 0))
  ) %>%
  arrange(desc(`Cardiac Arrests`))

DT::datatable(
  sua_summary,
  options = list(
    pageLength = 10,
    scrollX = TRUE,
    order = list(list(4, 'desc'))  # Sort by cardiac arrests descending
  ),
  caption = "SUA Catchment Areas Summary"
) %>%
  DT::formatStyle(
    "Cardiac Arrests",
    backgroundColor = DT::styleInterval(c(1, 2), c("#ffffff", "#ffcccc", "#ffaaaa"))
  )
```

### Cardiac Arrest Distance Analysis

```{r arrest-distance-table}
arrest_summary <- vacar_export %>%
  select(
    Date = va_date,
    Age = va_ageyears,
    Gender = va_malegender,
    `Distance to AED (m)` = distance2defib,
    `Time to AED (min)` = duration2defib,
    `Closest AED` = closest_defib_name,
    `Within SUA` = within_how_many_sua
  ) %>%
  mutate(
    Gender = ifelse(Gender, "Male", "Female"),
    `Distance to AED (m)` = round(`Distance to AED (m)`, 0),
    `Time to AED (min)` = round(`Time to AED (min)`, 1),
    `Within SUA` = ifelse(coalesce(`Within SUA`, 0) > 0, "Yes", "No")
  ) %>%
  arrange(`Distance to AED (m)`)

DT::datatable(
  arrest_summary,
  options = list(
    pageLength = 10,
    scrollX = TRUE
  ),
  caption = "Cardiac Arrest Distance to Nearest AED"
) %>%
  DT::formatStyle(
    "Within SUA",
    backgroundColor = DT::styleEqual("Yes", "#ccffcc")
  ) %>%
  DT::formatStyle(
    "Distance to AED (m)",
    backgroundColor = DT::styleInterval(c(500, 1000), c("#ccffcc", "#ffffcc", "#ffcccc"))
  )
```

## Analysis Notes

- **SUA Catchments** represent 2.479-minute walking distances from each AED using real street networks
- **Coverage** is low (4%) indicating most cardiac arrests occur outside walkable distance to AEDs
- **SJA vs Non-SJA** analysis shows the impact of different AED provider networks
- **Distance metrics** use OSRM routing engine for realistic travel times and distances

---
*Generated from R targets pipeline data at `r Sys.time()`*